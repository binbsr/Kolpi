@inject HttpClient Http

<RadzenPanel class="rz-mb-4 rz-border-info" AllowCollapse>
    <HeaderTemplate>
        <RadzenStack AlignItems="AlignItems.Center" Orientation="Orientation.Horizontal">
            <b>@Label</b>
            @((MarkupString)Data.Body)
        </RadzenStack>
    </HeaderTemplate>
    <ChildContent>
        <RadzenRow class="rz-my-2">
            <RadzenColumn SizeMD="10">
                <RadzenHtmlEditor @bind-Value=@Data.Body
                                  style="height: 145px;"
                                  UploadUrl="upload/image"
                                  Placeholder="Your question goes here..."
                                  Change="@OnBodyChange" />
                @if (!IsBodyValid)
                {
                    <div class="custom-warning">Question body must be supplied.</div>
                }
            </RadzenColumn>
            <RadzenColumn SizeMD="2">
                <RadzenButton Icon="remove_circle" Text="Remove" ButtonStyle="ButtonStyle.Danger" Click="RemoveQuestion" Style="width:100%;" />
                <RadzenText TextStyle="TextStyle.DisplayH5" class="rz-mt-4" TextAlign="TextAlign.Center">@Label</RadzenText>
                <RadzenDropDown class="rz-mt-4" Data="@(Enum.GetValues<QuestionType>().Cast<Enum>())" @bind-Value=@Data.Type Style="width:100%;" />
            </RadzenColumn>
            <RadzenColumn SizeMD="12">
                <RadzenDropDown @bind-Value=Data.Tags TValue="List<TagViewModel>" Data=@Tags Context="tag"
                                Multiple=true
                                AllowClear=true
                                AllowSelectAll=false
                                Placeholder="Add tags"
                                Chips=true
                                Style="width: 100%"
                                AllowFiltering
                                FilterAsYouType
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                MaxSelectedLabels="8"
                                Change="@OnTagsChange">
                    <Template>
                        <span style="@($"color: {tag.TagColorCode}")">
                            @tag.Name (@tag.TagTypeName)
                        </span>
                    </Template>
                </RadzenDropDown>
                @if(!AreTagsValid)
                {
                    <div class="custom-warning">At least one tag must be selected.</div>
                }
            </RadzenColumn>
        </RadzenRow>

        @if (Data.Type == QuestionType.Objective)
        {
            <RadzenRow>
                @{
                    char i = 'A';
                }
                @foreach (var option in Data.AnswerOptions)
                {
                    var optionLabel = "Option " + i++;
                    <RadzenColumn SizeMD="6" class="rz-background-color-base-200">
                        <AnsOption AnswerModel="@option" TextInputLabel="@optionLabel" RemoveItemCallback="() => DeleteAnsOption(option)" />
                        @if (string.IsNullOrWhiteSpace(option.Text))
                        {
                            <div class="custom-warning">Answer option cannot be empty.</div>
                        }
                    </RadzenColumn>
                }
                <RadzenButton Icon="add" Text="@($"Option {i}")" ButtonStyle="ButtonStyle.Success" Click="AddNewOption" title="Add new option" />
                @if (!AreAnswerOptionsValid)
                {
                    <div class="custom-warning">At least one answer option must be provided.</div>
                }
            </RadzenRow>
        }
    </ChildContent>
</RadzenPanel>

@code {
    [Parameter]
    public string Label { get; set; } = "";

    [Parameter]
    public EventCallback<QuestionAddViewModel> DeleteQuestionCallback { get; set; }

    [Parameter]
    public QuestionAddViewModel Data { get; set; } = new();

    private string searchText = string.Empty;
    private List<TagViewModel> Tags { get; set; } = default!;
    private bool IsBodyValid => !string.IsNullOrWhiteSpace(Data.Body);
    private bool AreTagsValid => Data.Tags != null && Data.Tags.Any();
    private bool AreAnswerOptionsValid => Data.AnswerOptions.Any(option => !string.IsNullOrWhiteSpace(option.Text));

    protected override async Task OnInitializedAsync()
    {
        Data.AnswerOptions = new() { new(), new(), new(), new() };
        var result = await Http.GetFromJsonAsync<TagsMetaViewModel>($"api/tags?take=999999") ?? new TagsMetaViewModel();
        Tags = result.Records;
    }

    private void RemoveQuestion()
    {
        DeleteQuestionCallback.InvokeAsync(Data);
    }

    public void AddNewOption()
    {
        Data.AnswerOptions.Add(new AnswerOptionViewModel());
    }

    public void DeleteAnsOption(AnswerOptionViewModel answerOption)
    {
        Data.AnswerOptions.Remove(answerOption);
    }

    public async Task<IEnumerable<TagViewModel>> Search(string value)
    {
        List<TagViewModel> emptyModel = new();

        if (string.IsNullOrWhiteSpace(value))
            return emptyModel;

        Tags = await Http.GetFromJsonAsync<List<TagViewModel>>($"api/tags?searchText={value}") ?? emptyModel;
        return Tags;
    }

    private void OnBodyChange(object value)
    {
        Data.Body = value.ToString();
        StateHasChanged(); // Refresh the state to check for validation
    }

    private void OnTagsChange(object value)
    {
        Data.Tags = value as List<TagViewModel>;
        StateHasChanged(); // Refresh the state to check for validation
    }

    private void OnOptionChange(object value)
    {
        var option = value as AnswerOptionViewModel;
        var index = Data.AnswerOptions.FindIndex(o => o.Equals(option));
        if (index >= 0)
        {
            Data.AnswerOptions[index] = option;
        }
        StateHasChanged(); // Refresh the state to check for validation
    }
}
